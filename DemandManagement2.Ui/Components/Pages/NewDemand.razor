@page "/demands/new"
@rendermode InteractiveServer
@inject DemandManagement2.Ui.Services.DemandApiClient Api
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<div class="dm-page">
    <div class="dm-page__header">
        <div>
            <div class="dm-pill">New Request</div>
            <h1 class="dm-title">Submit New Demand</h1>
            <p class="dm-subtitle">Fill out the form below to submit a new demand request for review. All roles can submit demands.</p>
        </div>
        <div class="dm-actions">
            <a href="/demands" class="dm-btn dm-btn--ghost">Back to List</a>
            <a href="/dashboard" class="dm-btn dm-btn--ghost">Dashboard</a>
        </div>
    </div>

    <div class="dm-card">
        <div class="dm-card__header">
            <div>
                <div class="dm-card__title">Request Details</div>
                <div class="dm-card__hint">All fields are required</div>
            </div>
        </div>

        <div class="dm-form">
            <div class="dm-form-row dm-form-row--full">
                <label for="title">Title</label>
                <input id="title" class="dm-input" @bind="_model.Title" placeholder="Brief title for this request" />
            </div>

            <div class="dm-form-row dm-form-row--full">
                <label for="problemStatement">Problem Statement</label>
                <textarea id="problemStatement" class="dm-input dm-textarea" @bind="_model.ProblemStatement" rows="4" placeholder="Describe the problem or need in detail..."></textarea>
            </div>

            <div class="dm-form-grid">
                <div class="dm-form-row">
                    <label for="type">Type</label>
                    <select id="type" class="dm-input dm-select" @bind="_model.Type">
                        <option value="@DemandManagement2.Ui.Services.DemandType.Project">Project</option>
                        <option value="@DemandManagement2.Ui.Services.DemandType.Enhancement">Enhancement</option>
                        <option value="@DemandManagement2.Ui.Services.DemandType.Service">Service</option>
                        <option value="@DemandManagement2.Ui.Services.DemandType.ResourceRequest">Resource Request</option>
                    </select>
                </div>

                <div class="dm-form-row">
                    <label for="businessUnit">Business Unit</label>
                    <input id="businessUnit" class="dm-input" @bind="_model.BusinessUnit" placeholder="e.g., Finance, IT, Marketing" />
                </div>

                <div class="dm-form-row">
                    <label for="requestedBy">Requested By</label>
                    <input id="requestedBy" class="dm-input" @bind="_model.RequestedBy" readonly />
                </div>

                <div class="dm-form-row">
                    <label for="urgency">Urgency (1-5)</label>
                    <input id="urgency" class="dm-input" type="number" min="1" max="5" @bind="_model.Urgency" />
                    <span class="dm-form-hint">1 = Low, 5 = Critical</span>
                </div>

                <div class="dm-form-row">
                    <label for="estimatedEffort">Estimated Effort (1-5)</label>
                    <input id="estimatedEffort" class="dm-input" type="number" min="1" max="5" @bind="_model.EstimatedEffort" />
                    <span class="dm-form-hint">1 = Small, 5 = Large</span>
                </div>

                <div class="dm-form-row">
                    <label for="targetDate">Target Date (SLA)</label>
                    <input id="targetDate" class="dm-input" type="date" @bind="_targetDate" />
                    <span class="dm-form-hint">Expected completion date</span>
                </div>
            </div>

            <div class="dm-form-row dm-form-row--full">
                <label>Supporting Documents</label>
                <div class="dm-upload-area">
                    <InputFile OnChange="OnFilesSelected" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.png,.jpg,.jpeg,.txt,.csv,.zip" class="dm-input-file" />
                    <span class="dm-form-hint">Max 5 files, 10 MB each. Allowed: PDF, Word, Excel, PowerPoint, images, text, CSV, ZIP</span>
                </div>
                @if (_selectedFiles.Any())
                {
                    <div class="dm-file-list">
                        @foreach (var f in _selectedFiles)
                        {
                            <div class="dm-file-item">
                                <span>@f.Name (@FormatFileSize(f.Size))</span>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="dm-form-actions">
                <button class="dm-btn dm-btn--primary dm-btn--lg" @onclick="Submit" disabled="@_submitting">
                    @(_submitting ? "Submitting..." : "Submit Request")
                </button>
                <span class="dm-msg @(_message.Contains("failed") ? "dm-msg--error" : "")">@_message</span>
            </div>
        </div>
    </div>
</div>

@code {
    private DemandManagement2.Ui.Services.CreateDemandRequest _model = new();
    private string _message = "";
    private DateTime? _targetDate;
    private List<IBrowserFile> _selectedFiles = new();
    private bool _submitting = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var fullName = authState.User.Identity?.Name ?? "";
        _model.RequestedBy = fullName;
    }

    private void OnFilesSelected(InputFileChangeEventArgs e)
    {
        _selectedFiles = e.GetMultipleFiles(5).ToList();
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    private async Task Submit()
    {
        try
        {
            _submitting = true;
            _message = "Submitting...";
            StateHasChanged();

            _model.TargetDate = _targetDate;

            var demandId = await Api.CreateDemand(_model);

            // Upload files
            if (_selectedFiles.Any() && demandId != Guid.Empty)
            {
                foreach (var file in _selectedFiles)
                {
                    _message = $"Uploading {file.Name}...";
                    StateHasChanged();

                    using var stream = file.OpenReadStream(10 * 1024 * 1024);
                    await Api.UploadAttachment(demandId, stream, file.Name, file.ContentType);
                }
            }

            _message = "Submitted!";
            Nav.NavigateTo("/demands");
        }
        catch (Exception ex)
        {
            _message = $"Submit failed: {ex.Message}";
        }
        finally
        {
            _submitting = false;
        }
    }
}

<style>
:root{
  --dm-border: rgba(255,205,17,.18);
  --dm-text: rgba(255,255,255,.92);
  --dm-muted: rgba(255,255,255,.68);
  --dm-faint: rgba(255,255,255,.48);
  --dm-primary: #ffcd11;
  --dm-primary-2: #e6b000;
  --dm-success: #22c55e;
}

.dm-page{ max-width: 800px; }

.dm-page__header{
  display:flex;
  align-items:flex-start;
  justify-content: space-between;
  gap: 14px;
  margin: 10px 0 20px;
  flex-wrap: wrap;
}

.dm-title{
  margin: 8px 0 6px;
  font-size: 28px;
  letter-spacing: -.02em;
  color: var(--dm-text);
}
.dm-subtitle{
  margin: 0;
  color: var(--dm-muted);
  line-height: 1.6;
}

.dm-actions{ display:flex; gap: 10px; flex-wrap: wrap; }

.dm-pill{
  display:inline-flex;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--dm-border);
  background: rgba(255,255,255,.06);
  color: var(--dm-muted);
  font-size: 12px;
  letter-spacing: .08em;
  text-transform: uppercase;
}

.dm-card{
  background: rgba(255,255,255,.04);
  border: 1px solid var(--dm-border);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
}
.dm-card__header{
  display:flex;
  justify-content: space-between;
  align-items:flex-start;
  gap: 12px;
  margin-bottom: 20px;
}
.dm-card__title{ font-weight: 900; color: var(--dm-text); font-size: 18px; }
.dm-card__hint{ font-size: 12.5px; color: var(--dm-faint); margin-top: 2px; }

.dm-btn{
  display: inline-flex;
  align-items: center;
  border: 1px solid var(--dm-border);
  padding: 10px 14px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 800;
  text-decoration: none;
  transition: transform .12s ease, background .12s ease;
}
.dm-btn--lg{
  padding: 12px 24px;
  font-size: 15px;
}
.dm-btn--primary{
  background: linear-gradient(180deg, var(--dm-primary), var(--dm-primary-2));
  color: white;
  border-color: rgba(255,205,17,.55);
}
.dm-btn--primary:hover{ transform: translateY(-1px); }
.dm-btn--ghost{
  background: rgba(255,255,255,.04);
  color: var(--dm-text);
}
.dm-btn--ghost:hover{ transform: translateY(-1px); background: rgba(255,255,255,.07); }

.dm-form{ display: flex; flex-direction: column; gap: 16px; }

.dm-form-grid{
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

.dm-form-row{
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.dm-form-row--full{
  grid-column: 1 / -1;
}
.dm-form-row label{
  font-size: 13px;
  color: var(--dm-muted);
  font-weight: 600;
}

.dm-form-hint{
  font-size: 11px;
  color: var(--dm-faint);
  margin-top: 2px;
}

.dm-input{
  background: rgba(0,0,0,.25);
  border: 1px solid var(--dm-border);
  border-radius: 10px;
  padding: 12px 14px;
  color: var(--dm-text);
  font-size: 14px;
  transition: border-color .15s ease;
}
.dm-input:focus{
  outline: none;
  border-color: var(--dm-primary);
}
.dm-input::placeholder{
  color: var(--dm-faint);
}

.dm-select{
  cursor: pointer;
}

.dm-textarea{
  resize: vertical;
  min-height: 100px;
}

.dm-form-actions{
  display: flex;
  align-items: center;
  gap: 16px;
  margin-top: 8px;
  padding-top: 16px;
  border-top: 1px solid var(--dm-border);
}

.dm-msg{
  font-size: 14px;
  color: var(--dm-success);
  font-weight: 600;
}
.dm-msg--error{
  color: #f87171;
}

.dm-upload-area{
  border: 2px dashed var(--dm-border);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
}
.dm-input-file{
  color: var(--dm-muted);
}
.dm-file-list{
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 8px;
}
.dm-file-item{
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: rgba(255,255,255,.06);
  border: 1px solid var(--dm-border);
  border-radius: 8px;
  font-size: 13px;
  color: var(--dm-muted);
}

@@media (max-width: 600px){
  .dm-page__header{ flex-direction: column; }
  .dm-form-grid{ grid-template-columns: 1fr; }
}
</style>
