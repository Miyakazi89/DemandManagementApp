@page "/demands/{Id:guid}"
@rendermode InteractiveServer
@inject DemandManagement2.Ui.Services.DemandApiClient Api
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IConfiguration Config

<div class="dm-page">
    @if (_demand is null)
    {
        <div class="dm-loading">Loading...</div>
    }
    else
    {
        <div class="dm-page__header">
            <div>
                <div class="dm-pill">Details</div>
                <h1 class="dm-title">@_demand.Title</h1>
                <div class="dm-meta-row">
                    <span class="dm-pillSmall dm-pillSmall--status">@_demand.Status</span>
                    <span class="dm-pillSmall">@_demand.Type</span>
                    @if (_demand.WeightedScore is not null)
                    {
                        <span class="dm-pillSmall dm-pillSmall--score">Score @_demand.WeightedScore</span>
                    }
                </div>
            </div>
            <div class="dm-actions">
                <a href="/demands" class="dm-btn dm-btn--ghost">Back to List</a>
                <a href="/dashboard" class="dm-btn dm-btn--ghost">Dashboard</a>
                @if (_isAdminOrAssessor)
                {
                    <button class="dm-btn dm-btn--warning" @onclick="() => _showRequestInfo = !_showRequestInfo" disabled="@(_demand.Status == "NeedsInfo")">
                        Request Info
                    </button>
                    <button class="dm-btn dm-btn--danger" @onclick="DeleteDemand" disabled="@_deleting">
                        @(_deleting ? "Deleting..." : "Delete")
                    </button>
                }
            </div>
        </div>

        @if (_showRequestInfo && _isAdminOrAssessor)
        {
            <div class="dm-card dm-mt" style="border-color: rgba(245,158,11,.35);">
                <div class="dm-card__title" style="margin-bottom:10px;">Request Additional Information</div>
                <div class="dm-card__hint" style="margin-bottom:12px;">Describe what information you need from the requester.</div>
                <div class="dm-form">
                    <div class="dm-form-row">
                        <label>What information is needed?</label>
                        <textarea class="dm-input dm-textarea" @bind="_requestInfoMessage" rows="3" placeholder="e.g. Please provide budget estimates, stakeholder approvals, or technical specifications..."></textarea>
                    </div>
                    <div class="dm-form-actions">
                        <button class="dm-btn dm-btn--warning" @onclick="RequestMoreInfo" disabled="@(string.IsNullOrWhiteSpace(_requestInfoMessage))">Send Request</button>
                        <button class="dm-btn dm-btn--ghost" @onclick="() => _showRequestInfo = false">Cancel</button>
                    </div>
                </div>
            </div>
        }

        <div class="dm-grid dm-grid--2 dm-gap">
            <!-- Left Column: Demand Info -->
            <div class="dm-card">
                <div class="dm-card__header">
                    <div>
                        <div class="dm-card__title">Request Information</div>
                        <div class="dm-card__hint">Details about this demand request</div>
                    </div>
                </div>

                <div class="dm-info-list">
                    <div class="dm-info-item">
                        <div class="dm-info-label">Business Unit</div>
                        <div class="dm-info-value">@_demand.BusinessUnit</div>
                    </div>
                    <div class="dm-info-item">
                        <div class="dm-info-label">Requested By</div>
                        <div class="dm-info-value">@_demand.RequestedBy</div>
                    </div>
                    <div class="dm-info-item">
                        <div class="dm-info-label">Urgency</div>
                        <div class="dm-info-value">@_demand.Urgency / 5</div>
                    </div>
                    <div class="dm-info-item">
                        <div class="dm-info-label">Estimated Effort</div>
                        <div class="dm-info-value">@_demand.EstimatedEffort / 5</div>
                    </div>
                    <div class="dm-info-item">
                        <div class="dm-info-label">Created</div>
                        <div class="dm-info-value">@_demand.CreatedAtUtc.ToString("dd MMM yyyy HH:mm")</div>
                    </div>
                    <div class="dm-info-item">
                        <div class="dm-info-label">Target Date (SLA)</div>
                        @if (_demand.TargetDate.HasValue)
                        {
                            <div class="dm-info-value">
                                @_demand.TargetDate.Value.ToString("dd MMM yyyy")
                                @{ var daysLeft = (_demand.TargetDate.Value - DateTime.UtcNow).Days; }
                                @if (daysLeft < 0)
                                {
                                    <span class="dm-sla-badge dm-sla--overdue">OVERDUE by @Math.Abs(daysLeft) days</span>
                                }
                                else if (daysLeft <= 7)
                                {
                                    <span class="dm-sla-badge dm-sla--warning">@daysLeft days left</span>
                                }
                                else
                                {
                                    <span class="dm-sla-badge dm-sla--ok">@daysLeft days left</span>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="dm-info-value" style="color:var(--dm-faint)">Not set</div>
                        }
                    </div>
                </div>

                <div class="dm-divider"></div>

                <div class="dm-info-item">
                    <div class="dm-info-label">Problem Statement</div>
                    <div class="dm-info-value dm-info-value--text">@_demand.ProblemStatement</div>
                </div>

                @if (!_isAdminOrAssessor && (_demand.Status == "Intake" || _demand.Status == "NeedsInfo"))
                {
                    <div class="dm-divider"></div>
                    @if (_demand.Status == "NeedsInfo")
                    {
                        <div class="dm-info-requested-box">
                            <div class="dm-info-requested-title">Additional Information Requested</div>
                            @{
                                var latestInfoEvent = _demand.Events?
                                    .Where(e => e.EventType == "InfoRequested")
                                    .OrderByDescending(e => e.OccurredAtUtc)
                                    .FirstOrDefault();
                            }
                            @if (latestInfoEvent is not null)
                            {
                                <div class="dm-info-requested-msg">@latestInfoEvent.Description</div>
                                <div class="dm-info-requested-meta">@latestInfoEvent.OccurredAtUtc.ToString("dd MMM yyyy HH:mm")</div>
                            }
                            <div class="dm-card__hint" style="color:#fbbf24; margin-top:8px;">
                                Please update your demand below to address the request.
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="dm-card__hint" style="color:#ffcd11; margin-bottom:10px;">
                            You can edit your request while it is still in Intake.
                        </div>
                    }
                    <div class="dm-form">
                        <div class="dm-form-row">
                            <label>Title</label>
                            <input class="dm-input" @bind="_editRequest.Title" />
                        </div>
                        <div class="dm-form-row">
                            <label>Problem Statement</label>
                            <textarea class="dm-input dm-textarea" @bind="_editRequest.ProblemStatement" rows="4"></textarea>
                        </div>
                        <div class="dm-form-row">
                            <label>Urgency (1-5)</label>
                            <input class="dm-input" type="number" min="1" max="5" @bind="_editRequest.Urgency" />
                        </div>
                        <div class="dm-form-row">
                            <label>Estimated Effort (1-5)</label>
                            <input class="dm-input" type="number" min="1" max="5" @bind="_editRequest.EstimatedEffort" />
                        </div>
                        <div class="dm-form-row">
                            <label>Target Date (Estimated Finish)</label>
                            <input class="dm-input" type="date" @bind="_editTargetDate" />
                        </div>
                        <div class="dm-form-actions">
                            <button class="dm-btn dm-btn--primary" @onclick="SubmitUpdate">Submit Update</button>
                            <span class="dm-msg @(_msgU.Contains("Error") ? "dm-msg--error" : "")">@_msgU</span>
                        </div>
                    </div>
                }
            </div>

            <!-- Right Column: Assessment (Admin/Assessor only) -->
            <div class="dm-card">
                <div class="dm-card__header">
                    <div>
                        <div class="dm-card__title">Assessment</div>
                        <div class="dm-card__hint">Score this demand (1-5 for each)</div>
                    </div>
                    <span class="dm-badge dm-badge--info">Step 1</span>
                </div>

                @if (_isAdminOrAssessor)
                {
                <div class="dm-form">
                    <div class="dm-form-row">
                        <label>Business Value</label>
                        <input class="dm-input" type="number" min="1" max="5" @bind="_assessment.BusinessValue" />
                    </div>

                    <div class="dm-form-row">
                        <label>Cost Impact</label>
                        <input class="dm-input" type="number" min="1" max="5" @bind="_assessment.CostImpact" />
                    </div>

                    <div class="dm-form-row">
                        <label>Risk</label>
                        <input class="dm-input" type="number" min="1" max="5" @bind="_assessment.Risk" />
                    </div>

                    <div class="dm-form-row">
                        <label>Resource Need</label>
                        <input class="dm-input" type="number" min="1" max="5" @bind="_assessment.ResourceNeed" />
                    </div>

                    <div class="dm-form-row">
                        <label>Strategic Alignment</label>
                        <input class="dm-input" type="number" min="1" max="5" @bind="_assessment.StrategicAlignment" />
                    </div>

                    <div class="dm-divider"></div>
                    <div class="dm-card__hint">Financial Analysis (NPV)</div>

                    <div class="dm-form-row">
                        <label>Initial Cost</label>
                        <input class="dm-input" type="number" step="0.01" min="0" @bind="_assessment.InitialCost" />
                    </div>

                    <div class="dm-form-row">
                        <label>Annual Benefit</label>
                        <input class="dm-input" type="number" step="0.01" min="0" @bind="_assessment.AnnualBenefit" />
                    </div>

                    <div class="dm-form-row">
                        <label>Project Years</label>
                        <input class="dm-input" type="number" min="1" max="50" @bind="_assessment.ProjectYears" />
                    </div>

                    <div class="dm-form-row">
                        <label>Discount Rate (%)</label>
                        <input class="dm-input" type="number" step="0.01" min="0" max="100" @bind="_assessment.DiscountRate" />
                    </div>

                    @if (_demand?.Assessment is not null)
                    {
                        <div class="dm-form-row">
                            <label>Calculated NPV</label>
                            <div class="dm-info-value">@_demand.Assessment.CalculatedNPV</div>
                            <div class="dm-card__hint">NPV updates after saving the assessment.</div>
                        </div>
                    }

                    <div class="dm-divider"></div>
                    <div class="dm-card__hint">Budget Breakdown</div>

                    <div class="dm-form-row">
                        <label>CapEx Amount</label>
                        <input class="dm-input" type="number" step="0.01" min="0" @bind="_assessment.CapExAmount" />
                    </div>

                    <div class="dm-form-row">
                        <label>OpEx Amount</label>
                        <input class="dm-input" type="number" step="0.01" min="0" @bind="_assessment.OpExAmount" />
                    </div>

                    <div class="dm-form-row">
                        <label>Assessed By</label>
                        <input class="dm-input" @bind="_assessment.AssessedBy" placeholder="Your name" />
                    </div>

                    <div class="dm-form-actions">
                        <button class="dm-btn dm-btn--primary" @onclick="SaveAssessment">Save Assessment</button>
                        <span class="dm-msg @(_msgA.Contains("Error") ? "dm-msg--error" : "")">@_msgA</span>
                    </div>
                </div>
                }
                else
                {
                    <div class="dm-empty">Only Admin and Assessor roles can perform assessments.</div>
                }
            </div>
        </div>

        @if (_isAdminOrAssessor)
        {
        <!-- Approval Section -->
        <div class="dm-card dm-mt">
            <div class="dm-card__header">
                <div>
                    <div class="dm-card__title">Approval Decision</div>
                    <div class="dm-card__hint">Make a decision on this demand request</div>
                </div>
                <span class="dm-badge dm-badge--ghost">Step 2</span>
            </div>

            <div class="dm-form dm-form--inline">
                <div class="dm-form-row">
                    <label>Decision</label>
                    <select class="dm-input dm-select" @bind="_approval.Status">
                        <option value="@DemandManagement2.Ui.Services.ApprovalStatus.Approved">Approved</option>
                        <option value="@DemandManagement2.Ui.Services.ApprovalStatus.Rejected">Rejected</option>
                        <option value="@DemandManagement2.Ui.Services.ApprovalStatus.OnHold">On Hold</option>
                    </select>
                </div>

                <div class="dm-form-row">
                    <label>Decision By</label>
                    <input class="dm-input" @bind="_approval.DecisionBy" placeholder="Your name" />
                </div>

                <div class="dm-form-row dm-form-row--full">
                    <label>Comments</label>
                    <textarea class="dm-input dm-textarea" @bind="_approval.Comments" rows="3" placeholder="Optional comments..."></textarea>
                </div>

                <div class="dm-form-actions">
                    <button class="dm-btn dm-btn--success" @onclick="SaveApproval">Save Approval</button>
                    <span class="dm-msg @(_msgP.Contains("Error") ? "dm-msg--error" : "")">@_msgP</span>
                </div>
            </div>
        </div>
        }

        <!-- Decision Notes Section -->
        <div class="dm-card dm-mt">
            <div class="dm-card__header">
                <div>
                    <div class="dm-card__title">Meeting Notes & Decisions</div>
                    <div class="dm-card__hint">Record discussions and decisions for this demand</div>
                </div>
                <button class="dm-btn dm-btn--ghost" @onclick="() => _showAddNote = true">+ Add Note</button>
            </div>

            @if (_notes is null)
            {
                <div class="dm-loading">Loading notes...</div>
            }
            else if (_notes.Count == 0)
            {
                <div class="dm-empty">No meeting notes recorded yet.</div>
            }
            else
            {
                <div class="dm-notes-list">
                    @foreach (var note in _notes)
                    {
                        <div class="dm-note-card">
                            <div class="dm-note-header">
                                <span class="dm-note-date">@note.MeetingDate</span>
                                <span class="dm-note-by">Recorded by @note.RecordedBy</span>
                            </div>
                            <div class="dm-note-section">
                                <div class="dm-note-label">Attendees</div>
                                <div class="dm-note-value">@note.Attendees</div>
                            </div>
                            <div class="dm-note-section">
                                <div class="dm-note-label">Discussion</div>
                                <div class="dm-note-value">@note.Discussion</div>
                            </div>
                            <div class="dm-note-section">
                                <div class="dm-note-label">Decision</div>
                                <div class="dm-note-value dm-note-value--highlight">@note.Decision</div>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(note.ActionItems))
                            {
                                <div class="dm-note-section">
                                    <div class="dm-note-label">Action Items</div>
                                    <div class="dm-note-value">@note.ActionItems</div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Attachments Section -->
        <div class="dm-card dm-mt">
            <div class="dm-card__header">
                <div>
                    <div class="dm-card__title">Attachments</div>
                    <div class="dm-card__hint">Supporting documents for this demand</div>
                </div>
            </div>

            @if (_demand.Attachments is null || _demand.Attachments.Count == 0)
            {
                <div class="dm-empty">No attachments uploaded yet.</div>
            }
            else
            {
                <div class="dm-attach-list">
                    @foreach (var att in _demand.Attachments)
                    {
                        <div class="dm-attach-item">
                            <div class="dm-attach-info">
                                <span class="dm-attach-name">@att.FileName</span>
                                <span class="dm-attach-meta">@FormatFileSize(att.FileSizeBytes) &middot; Uploaded by @att.UploadedBy &middot; @att.UploadedAtUtc.ToString("dd MMM yyyy HH:mm")</span>
                            </div>
                            <div class="dm-attach-actions">
                                <a href="@($"{_apiBase}{att.DownloadUrl}")" target="_blank" class="dm-btn dm-btn--ghost" style="padding:6px 10px; font-size:12px;">Download</a>
                                @if (_isAdminOrAssessor)
                                {
                                    <button class="dm-btn dm-btn--danger" style="padding:6px 10px; font-size:12px;" @onclick="() => DeleteAttachment(att.Id)">Delete</button>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Activity Timeline -->
        <div class="dm-card dm-mt">
            <div class="dm-card__header">
                <div>
                    <div class="dm-card__title">Activity Timeline</div>
                    <div class="dm-card__hint">History of all actions on this demand</div>
                </div>
            </div>

            @if (_demand.Events is null || _demand.Events.Count == 0)
            {
                <div class="dm-empty">No events recorded yet.</div>
            }
            else
            {
                <div class="dm-timeline">
                    @foreach (var evt in _demand.Events)
                    {
                        <div class="dm-timeline-item">
                            <div class="dm-timeline-dot @GetTimelineDotClass(evt.EventType)"></div>
                            <div class="dm-timeline-content">
                                <div class="dm-timeline-header">
                                    <span class="dm-timeline-type">@evt.EventType</span>
                                    <span class="dm-timeline-time">@evt.OccurredAtUtc.ToString("dd MMM yyyy HH:mm")</span>
                                </div>
                                <div class="dm-timeline-desc">@evt.Description</div>
                                <div class="dm-timeline-by">by @evt.PerformedBy</div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Add Note Modal -->
        @if (_showAddNote)
        {
            <div class="dm-modal-overlay" @onclick="() => _showAddNote = false">
                <div class="dm-modal" @onclick:stopPropagation="true">
                    <div class="dm-modal__header">
                        <div class="dm-modal__title">Add Meeting Note</div>
                        <button class="dm-modal__close" @onclick="() => _showAddNote = false">&times;</button>
                    </div>
                    <div class="dm-form">
                        <div class="dm-form-row">
                            <label>Meeting Date</label>
                            <input type="date" class="dm-input" @bind="_meetingDate" />
                        </div>
                        <div class="dm-form-row">
                            <label>Attendees</label>
                            <input class="dm-input" @bind="_newNote.Attendees" placeholder="Names of attendees" />
                        </div>
                        <div class="dm-form-row">
                            <label>Discussion</label>
                            <textarea class="dm-input dm-textarea" @bind="_newNote.Discussion" rows="3"></textarea>
                        </div>
                        <div class="dm-form-row">
                            <label>Decision</label>
                            <textarea class="dm-input dm-textarea" @bind="_newNote.Decision" rows="2"></textarea>
                        </div>
                        <div class="dm-form-row">
                            <label>Action Items</label>
                            <textarea class="dm-input dm-textarea" @bind="_newNote.ActionItems" rows="2"></textarea>
                        </div>
                        <div class="dm-form-row">
                            <label>Recorded By</label>
                            <input class="dm-input" @bind="_newNote.RecordedBy" placeholder="Your name" />
                        </div>
                        <div class="dm-form-actions">
                            <button class="dm-btn dm-btn--primary" @onclick="SaveNote">Save Note</button>
                            <span class="dm-msg @(_msgN.Contains("Error") ? "dm-msg--error" : "")">@_msgN</span>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter] public Guid Id { get; set; }

    private DemandManagement2.Ui.Services.DemandDetails? _demand;
    private DemandManagement2.Ui.Services.CreateOrUpdateAssessment _assessment = new();
    private DemandManagement2.Ui.Services.CreateApproval _approval = new();
    private List<DemandManagement2.Ui.Services.DecisionNoteItem>? _notes;
    private DemandManagement2.Ui.Services.CreateDecisionNoteRequest _newNote = new();
    private bool _showAddNote;
    private bool _isAdminOrAssessor;
    private bool _deleting;
    private DateTime _meetingDate = DateTime.Today;
    private DemandManagement2.Ui.Services.CreateDemandRequest _editRequest = new();
    private string _msgA = "";
    private string _msgP = "";
    private string _msgN = "";
    private string _msgU = "";
    private string _apiBase = "";
    private bool _showRequestInfo;
    private string _requestInfoMessage = "";
    private DateTime _editTargetDate = DateTime.Today;

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    private string GetTimelineDotClass(string eventType) => eventType switch
    {
        "Created" => "dm-dot--blue",
        "Assessed" => "dm-dot--cyan",
        "Approved" => "dm-dot--green",
        "Rejected" => "dm-dot--red",
        "OnHold" => "dm-dot--yellow",
        "Updated" => "dm-dot--purple",
        "InfoRequested" => "dm-dot--yellow",
        "NoteAdded" => "dm-dot--gray",
        "FileUploaded" => "dm-dot--teal",
        _ => "dm-dot--gray"
    };

    private async Task DeleteAttachment(Guid attachmentId)
    {
        try
        {
            await Api.DeleteAttachment(Id, attachmentId);
            await Load();
        }
        catch (Exception ex)
        {
            _msgA = $"Error: {ex.Message}";
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _apiBase = (Config["ApiBaseUrl"] ?? "http://localhost:5182").TrimEnd('/');

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _isAdminOrAssessor = user.IsInRole("Admin") || user.IsInRole("Assessor");

        await Load();
    }

    private async Task DeleteDemand()
    {
        _deleting = true;
        try
        {
            await Api.DeleteDemand(Id);
            Nav.NavigateTo("/demands");
        }
        catch (Exception ex)
        {
            _msgA = $"Error: {ex.Message}";
            _deleting = false;
        }
    }

    private async Task Load()
    {
        _demand = await Api.GetDemand(Id);
        _notes = await Api.GetDecisionNotes(Id);

        if (_demand?.Assessment is not null)
        {
            var a = _demand.Assessment;
            _assessment = new DemandManagement2.Ui.Services.CreateOrUpdateAssessment
            {
                BusinessValue = a.BusinessValue,
                CostImpact = a.CostImpact,
                Risk = a.Risk,
                ResourceNeed = a.ResourceNeed,
                StrategicAlignment = a.StrategicAlignment,

                InitialCost = a.InitialCost,
                AnnualBenefit = a.AnnualBenefit,
                ProjectYears = a.ProjectYears,
                DiscountRate = a.DiscountRate,

                CapExAmount = a.CapExAmount,
                OpExAmount = a.OpExAmount,

                AssessedBy = a.AssessedBy
            };
        }

        if (_demand?.Approval is not null)
        {
            var p = _demand.Approval;
            _approval = new DemandManagement2.Ui.Services.CreateApproval
            {
                Status = p.Status,
                DecisionBy = p.DecisionBy,
                Comments = p.Comments
            };
        }

        // Populate edit form for Requester updates
        if (_demand is not null)
        {
            _editRequest = new DemandManagement2.Ui.Services.CreateDemandRequest
            {
                Title = _demand.Title,
                ProblemStatement = _demand.ProblemStatement,
                Type = Enum.TryParse<DemandType>(_demand.Type, out var dt) ? dt : DemandType.Project,
                BusinessUnit = _demand.BusinessUnit,
                RequestedBy = _demand.RequestedBy,
                Urgency = _demand.Urgency,
                EstimatedEffort = (int)_demand.EstimatedEffort,
                TargetDate = _demand.TargetDate
            };
            _editTargetDate = _demand.TargetDate ?? DateTime.Today;
        }
    }

    private async Task SaveAssessment()
    {
        try
        {
            _msgA = "Saving...";
            StateHasChanged();

            await Api.SaveAssessment(Id, _assessment);
            await Load();

            _msgA = "Saved!";
        }
        catch (Exception ex)
        {
            _msgA = $"Error: {ex.Message}";
        }
    }

    private async Task SaveApproval()
    {
        try
        {
            _msgP = "Saving...";
            StateHasChanged();

            await Api.SaveApproval(Id, _approval);
            await Load();

            _msgP = "Saved!";
        }
        catch (Exception ex)
        {
            _msgP = $"Error: {ex.Message}";
        }
    }

    private async Task SaveNote()
    {
        try
        {
            _msgN = "Saving...";
            StateHasChanged();

            _newNote.MeetingDate = _meetingDate.ToString("yyyy-MM-dd");
            await Api.CreateDecisionNote(Id, _newNote);
            _notes = await Api.GetDecisionNotes(Id);

            _newNote = new();
            _meetingDate = DateTime.Today;
            _showAddNote = false;
            _msgN = "";
        }
        catch (Exception ex)
        {
            _msgN = $"Error: {ex.Message}";
        }
    }

    private async Task RequestMoreInfo()
    {
        try
        {
            await Api.RequestInfo(Id, _requestInfoMessage);
            _requestInfoMessage = "";
            _showRequestInfo = false;
            await Load();
        }
        catch (Exception ex)
        {
            _msgA = $"Error: {ex.Message}";
        }
    }

    private async Task SubmitUpdate()
    {
        try
        {
            _msgU = "Saving...";
            StateHasChanged();

            _editRequest.TargetDate = _editTargetDate;
            await Api.UpdateDemand(Id, _editRequest);
            await Load();

            _msgU = "Updated! Status changed to Under Review.";
        }
        catch (Exception ex)
        {
            _msgU = $"Error: {ex.Message}";
        }
    }
}

<style>
:root{
  --dm-border: rgba(255,205,17,.18);
  --dm-text: rgba(255,255,255,.92);
  --dm-muted: rgba(255,255,255,.68);
  --dm-faint: rgba(255,255,255,.48);
  --dm-primary: #ffcd11;
  --dm-primary-2: #e6b000;
  --dm-success: #22c55e;
  --dm-success-2: #16a34a;
  --dm-info: #ffcd11;
}

.dm-page{ max-width: 1100px; }

.dm-page__header{
  display:flex;
  align-items:flex-start;
  justify-content: space-between;
  gap: 14px;
  margin: 10px 0 20px;
  flex-wrap: wrap;
}

.dm-title{
  margin: 8px 0 10px;
  font-size: 26px;
  letter-spacing: -.02em;
  color: var(--dm-text);
}

.dm-meta-row{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.dm-actions{ display:flex; gap: 10px; flex-wrap: wrap; }

.dm-pill{
  display:inline-flex;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--dm-border);
  background: rgba(255,255,255,.06);
  color: var(--dm-muted);
  font-size: 12px;
  letter-spacing: .08em;
  text-transform: uppercase;
}

.dm-badge{
  display:inline-flex;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 800;
  border: 1px solid var(--dm-border);
}
.dm-badge--info{ background: rgba(255,205,17,.12); color: #a5f3fc; }
.dm-badge--ghost{ background: rgba(255,255,255,.04); color: var(--dm-muted); }

.dm-pillSmall{
  border: 1px solid var(--dm-border);
  background: rgba(255,255,255,.04);
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 850;
  color: var(--dm-text);
}
.dm-pillSmall--status{
  background: rgba(255,205,17,.15);
  border-color: rgba(255,205,17,.3);
  color: #ffcd11;
}
.dm-pillSmall--score{
  background: rgba(34,197,94,.12);
  border-color: rgba(34,197,94,.25);
  color: #bbf7d0;
}

.dm-grid{ display:grid; }
.dm-grid--2{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
.dm-gap{ gap: 16px; }
.dm-mt{ margin-top: 16px; }

.dm-card{
  background: rgba(255,255,255,.04);
  border: 1px solid var(--dm-border);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
}
.dm-card__header{
  display:flex;
  justify-content: space-between;
  align-items:flex-start;
  gap: 12px;
  margin-bottom: 16px;
}
.dm-card__title{ font-weight: 900; color: var(--dm-text); }
.dm-card__hint{ font-size: 12.5px; color: var(--dm-faint); margin-top: 2px; }

.dm-divider{ height:1px; background: var(--dm-border); margin: 16px 0; }

.dm-info-list{
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.dm-info-item{ margin-bottom: 8px; }
.dm-info-label{
  font-size: 12px;
  color: var(--dm-faint);
  margin-bottom: 4px;
  text-transform: uppercase;
  letter-spacing: .05em;
}
.dm-info-value{
  font-weight: 800;
  color: var(--dm-text);
}
.dm-info-value--text{
  font-weight: normal;
  line-height: 1.6;
  white-space: pre-wrap;
}

.dm-btn{
  display: inline-flex;
  align-items: center;
  border: 1px solid var(--dm-border);
  padding: 10px 14px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 800;
  text-decoration: none;
  transition: transform .12s ease, background .12s ease;
}
.dm-btn--primary{
  background: linear-gradient(180deg, var(--dm-primary), var(--dm-primary-2));
  color: white;
  border-color: rgba(255,205,17,.55);
}
.dm-btn--primary:hover{ transform: translateY(-1px); }
.dm-btn--success{
  background: linear-gradient(180deg, var(--dm-success), var(--dm-success-2));
  color: white;
  border-color: rgba(34,197,94,.55);
}
.dm-btn--success:hover{ transform: translateY(-1px); }
.dm-btn--danger{
  background: linear-gradient(180deg, #ef4444, #dc2626);
  color: white;
  border-color: rgba(239,68,68,.55);
}
.dm-btn--danger:hover{ transform: translateY(-1px); }
.dm-btn--danger:disabled{ opacity: .6; cursor: not-allowed; transform: none; }
.dm-btn--warning{
  background: linear-gradient(180deg, #f59e0b, #d97706);
  color: white;
  border-color: rgba(245,158,11,.55);
}
.dm-btn--warning:hover{ transform: translateY(-1px); }
.dm-btn--warning:disabled{ opacity: .6; cursor: not-allowed; transform: none; }
.dm-btn--ghost{
  background: rgba(255,255,255,.04);
  color: var(--dm-text);
}
.dm-btn--ghost:hover{ transform: translateY(-1px); background: rgba(255,255,255,.07); }

.dm-loading{
  padding: 60px;
  text-align: center;
  color: var(--dm-muted);
}

.dm-form{ display: flex; flex-direction: column; gap: 12px; }
.dm-form--inline{
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}
.dm-form-row{
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.dm-form-row--full{
  grid-column: 1 / -1;
}
.dm-form-row label{
  font-size: 13px;
  color: var(--dm-muted);
  font-weight: 600;
}

.dm-input{
  background: rgba(0,0,0,.25);
  border: 1px solid var(--dm-border);
  border-radius: 10px;
  padding: 10px 12px;
  color: var(--dm-text);
  font-size: 14px;
  transition: border-color .15s ease;
}
.dm-input:focus{
  outline: none;
  border-color: var(--dm-primary);
}
.dm-input::placeholder{
  color: var(--dm-faint);
}

.dm-select{
  cursor: pointer;
}

.dm-textarea{
  resize: vertical;
  min-height: 80px;
}

.dm-form-actions{
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 8px;
  grid-column: 1 / -1;
}

.dm-msg{
  font-size: 13px;
  color: var(--dm-success);
}
.dm-msg--error{
  color: #f87171;
}

.dm-loading, .dm-empty{
  padding: 30px;
  text-align: center;
  color: var(--dm-muted);
}

/* Notes styles */
.dm-notes-list{ display: flex; flex-direction: column; gap: 14px; }
.dm-note-card{
  background: rgba(0,0,0,.15);
  border: 1px solid var(--dm-border);
  border-radius: 12px;
  padding: 14px;
}
.dm-note-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--dm-border);
}
.dm-note-date{ font-weight: 800; color: var(--dm-text); }
.dm-note-by{ font-size: 12px; color: var(--dm-muted); }
.dm-note-section{ margin-bottom: 10px; }
.dm-note-label{ font-size: 11px; color: var(--dm-faint); text-transform: uppercase; letter-spacing: .05em; margin-bottom: 4px; }
.dm-note-value{ color: var(--dm-text); line-height: 1.5; white-space: pre-wrap; }
.dm-note-value--highlight{ color: var(--dm-info); font-weight: 600; }

/* Modal */
.dm-modal-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.dm-modal{
  background: #181818;
  border: 1px solid var(--dm-border);
  border-radius: 16px;
  padding: 20px;
  min-width: 450px;
  max-width: 90vw;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 50px rgba(0,0,0,.5);
}
.dm-modal__header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.dm-modal__title{ font-weight: 900; font-size: 18px; color: var(--dm-text); }
.dm-modal__close{
  background: none;
  border: none;
  color: var(--dm-muted);
  font-size: 24px;
  cursor: pointer;
  line-height: 1;
}
.dm-modal__close:hover{ color: var(--dm-text); }

/* Info Requested box */
.dm-info-requested-box{
  background: rgba(245,158,11,.08);
  border: 1px solid rgba(245,158,11,.3);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 14px;
}
.dm-info-requested-title{
  font-weight: 900;
  color: #fbbf24;
  font-size: 14px;
  margin-bottom: 8px;
}
.dm-info-requested-msg{
  color: var(--dm-text);
  font-size: 14px;
  line-height: 1.6;
  white-space: pre-wrap;
  padding: 8px 12px;
  background: rgba(0,0,0,.2);
  border-radius: 8px;
  border-left: 3px solid #f59e0b;
}
.dm-info-requested-meta{
  font-size: 11px;
  color: var(--dm-faint);
  margin-top: 6px;
}

/* SLA badges */
.dm-sla-badge{
  display: inline-block;
  padding: 3px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 800;
  margin-left: 8px;
}
.dm-sla--overdue{
  background: rgba(239,68,68,.2);
  color: #fca5a5;
  border: 1px solid rgba(239,68,68,.3);
}
.dm-sla--warning{
  background: rgba(245,158,11,.2);
  color: #fde68a;
  border: 1px solid rgba(245,158,11,.3);
}
.dm-sla--ok{
  background: rgba(34,197,94,.15);
  color: #bbf7d0;
  border: 1px solid rgba(34,197,94,.25);
}

/* Attachments */
.dm-attach-list{ display: flex; flex-direction: column; gap: 10px; }
.dm-attach-item{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  padding: 12px 14px;
  background: rgba(0,0,0,.15);
  border: 1px solid var(--dm-border);
  border-radius: 10px;
}
.dm-attach-info{ display: flex; flex-direction: column; gap: 4px; min-width: 0; }
.dm-attach-name{ font-weight: 700; color: var(--dm-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.dm-attach-meta{ font-size: 11px; color: var(--dm-faint); }
.dm-attach-actions{ display: flex; gap: 6px; flex-shrink: 0; }

/* Timeline */
.dm-timeline{ display: flex; flex-direction: column; gap: 0; padding-left: 20px; border-left: 2px solid var(--dm-border); }
.dm-timeline-item{
  display: flex;
  gap: 14px;
  padding: 12px 0;
  position: relative;
}
.dm-timeline-dot{
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
  margin-top: 4px;
  position: absolute;
  left: -27px;
}
.dm-dot--blue{ background: #3b82f6; }
.dm-dot--cyan{ background: #ffcd11; }
.dm-dot--green{ background: #22c55e; }
.dm-dot--red{ background: #ef4444; }
.dm-dot--yellow{ background: #f59e0b; }
.dm-dot--purple{ background: #a855f7; }
.dm-dot--teal{ background: #14b8a6; }
.dm-dot--gray{ background: rgba(255,255,255,.3); }

.dm-timeline-content{ padding-left: 4px; }
.dm-timeline-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-bottom: 4px;
}
.dm-timeline-type{ font-weight: 800; color: var(--dm-text); font-size: 13px; }
.dm-timeline-time{ font-size: 11px; color: var(--dm-faint); }
.dm-timeline-desc{ color: var(--dm-muted); font-size: 13px; line-height: 1.5; }
.dm-timeline-by{ font-size: 11px; color: var(--dm-faint); margin-top: 2px; }

@@media (max-width: 800px){
  .dm-grid--2{ grid-template-columns: 1fr; }
  .dm-form--inline{ grid-template-columns: 1fr; }
  .dm-page__header{ flex-direction: column; }
  .dm-info-list{ grid-template-columns: 1fr; }
  .dm-modal{ min-width: auto; width: 95vw; }
}
</style>
